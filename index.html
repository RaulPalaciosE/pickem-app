<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Pick'em League 2025-2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-container, .page-container { max-width: 800px; margin: 2rem auto; padding: 1.5rem; background-color: #f9fafb; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .team-pick-button { transition: all 0.2s ease-in-out; border: 2px solid #e5e7eb; }
        .team-pick-button.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; transform: scale(1.02); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-2">
    <div id="loading-overlay" class="loading-overlay"><div class="loader"></div></div>

    <div id="page-landing" class="page-container text-center hidden"><h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Welcome to the Pick'em League!</h1><p class="text-gray-600 mt-4 mb-8 text-lg">Make your picks or view the current standings.</p><div class="flex flex-col sm:flex-row justify-center gap-4"><button id="show-user-login-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-indigo-700 text-xl transition">Make Picks</button><button id="show-results-btn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-green-700 text-xl transition">View Results</button><button id="show-admin-login-btn" class="w-full sm:w-auto bg-gray-700 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 text-base transition mt-4 sm:mt-0">Admin</button></div></div>
    <div id="page-user-login" class="page-container hidden"><h2 class="text-3xl font-bold text-gray-900 text-center">Player Login</h2><div class="mt-6 space-y-4"><div><label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Select Your Name</label><select id="userName" name="userName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"></select></div><div><label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="userPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"></div><p id="user-error" class="text-red-500 text-sm hidden">Incorrect password.</p><button id="user-login-button" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Start Picking</button><div class="mt-4 text-center"><button id="back-to-landing-user-btn" class="text-sm text-gray-600 hover:text-indigo-600 transition">« Back to Home</button></div></div></div>
    <div id="page-admin-login" class="page-container hidden"><h2 class="text-3xl font-bold text-gray-900 text-center">Admin Login</h2><div class="mt-6"><label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="adminPassword" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"><p id="admin-error" class="text-red-500 text-sm mt-2 hidden">Incorrect password.</p><button id="admin-login-button" class="w-full mt-4 bg-gray-700 text-white font-bold py-3 rounded-lg hover:bg-gray-800 transition">Login</button><div class="mt-6 text-center"><button id="back-to-landing-admin-btn" class="text-sm text-gray-600 hover:text-indigo-600 transition">« Back to Home</button></div></div></div>
    <div id="page-user-form" class="form-container hidden"><div class="flex justify-between items-center mb-4"><button id="back-to-landing-picks-btn" class="text-sm text-gray-600 hover:text-indigo-600 transition">« Home</button><button id="logout-user-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm transition">Logout</button></div><div class="text-center mb-8"><h1 class="text-3xl sm:text-4xl font-bold text-gray-900">NFL Pick'em League</h1><p id="user-greeting" class="text-gray-600 mt-2 text-lg"></p></div><div class="bg-white p-6 rounded-lg shadow-md mb-8"><label for="weekSelectorUser" class="block text-lg font-medium text-gray-700 mb-2 text-center">Select Week</label><select id="weekSelectorUser" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"></select></div><div id="weeks-container-user"></div><div class="mt-12 text-center"><button id="submitPicksButton" class="bg-green-600 text-white font-bold py-4 px-10 rounded-lg hover:bg-green-700 transition text-xl flex items-center justify-center w-full sm:w-auto mx-auto"><span id="submit-button-text">Submit Picks</span><div id="submit-loader" class="loader hidden ml-3"></div></button><p id="submit-status" class="text-lg mt-4 text-center hidden"></p></div></div>
    <div id="page-admin-form" class="form-container hidden"><div class="flex justify-between items-center mb-4"><button id="back-to-landing-admin-main-btn" class="text-sm text-gray-600 hover:text-indigo-600 transition">« Home</button><button id="logout-admin-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 text-sm transition">Logout</button></div><div class="text-center mb-8"><h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Admin Panel</h1></div><div class="mb-8"><h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Enter Weekly Results</h2><div class="bg-white p-6 rounded-lg shadow-md"><label for="weekSelectorResults" class="block text-lg font-medium text-gray-700 mb-2 text-center">Select Week</label><select id="weekSelectorResults" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"></select></div><div id="weeks-container-results" class="mt-4"></div><div class="mt-6 text-center"><button id="calculateScoresButton" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-purple-700 transition">Save Winners & Calculate Scores</button><p id="admin-status" class="text-green-600 mt-4 text-sm text-center hidden"></p></div></div><div class="mb-8"><h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Set Point Values</h2><div class="bg-white p-6 rounded-lg shadow-md"><label for="weekSelectorAdmin" class="block text-lg font-medium text-gray-700 mb-2 text-center">Select Week to Edit</label><select id="weekSelectorAdmin" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 text-lg"></select></div><div id="weeks-container-admin" class="mt-4"></div><div class="mt-6 text-center"><button id="saveAdminChanges" class="bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-emerald-700 transition">Save Point Changes</button></div></div><div><h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Manage Players</h2><div id="player-management-container" class="space-y-3"></div><div class="mt-4"><button id="add-player-btn" class="text-indigo-600 font-semibold hover:underline">+ Add New Player</button></div><div class="mt-6 text-center"><button id="savePlayerChanges" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition">Save Player List</button></div></div></div>
    <div id="page-results" class="form-container hidden"><div class="flex justify-end mb-4"><button id="back-to-landing-results-btn" class="text-sm text-gray-600 hover:text-indigo-600 transition">« Home</button></div><div class="text-center mb-8"><h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Leaderboard</h1><div id="leaderboard-winner" class="mt-4 text-xl"></div></div><div id="leaderboard-container" class="overflow-x-auto bg-white p-4 rounded-lg shadow-sm"></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let scheduleData = []; let playerData = []; let currentUser = ''; let userPicks = {};
        const pages = { loading: document.getElementById('loading-overlay'), landing: document.getElementById('page-landing'), userLogin: document.getElementById('page-user-login'), adminLogin: document.getElementById('page-admin-login'), userForm: document.getElementById('page-user-form'), adminForm: document.getElementById('page-admin-form'), results: document.getElementById('page-results') };
        const allElements = {
            showUserLoginBtn: document.getElementById('show-user-login-btn'), showAdminLoginBtn: document.getElementById('show-admin-login-btn'), showResultsBtn: document.getElementById('show-results-btn'), userLoginBtn: document.getElementById('user-login-button'), adminLoginBtn: document.getElementById('admin-login-button'), 
            backBtns: document.querySelectorAll('#back-to-landing-user-btn, #back-to-landing-admin-btn, #back-to-landing-picks-btn, #back-to-landing-admin-main-btn, #back-to-landing-results-btn'),
            logoutUserBtn: document.getElementById('logout-user-btn'), logoutAdminBtn: document.getElementById('logout-admin-btn'), weekSelectorUser: document.getElementById('weekSelectorUser'), weekSelectorAdmin: document.getElementById('weekSelectorAdmin'), weekSelectorResults: document.getElementById('weekSelectorResults'), 
            userNameSelect: document.getElementById('userName'), userPasswordInput: document.getElementById('userPassword'), userError: document.getElementById('user-error'), adminPasswordInput: document.getElementById('adminPassword'), adminError: document.getElementById('admin-error'), 
            saveAdminChangesBtn: document.getElementById('saveAdminChanges'), savePlayerChangesBtn: document.getElementById('savePlayerChanges'), addPlayerBtn: document.getElementById('add-player-btn'), submitPicksButton: document.getElementById('submitPicksButton'), 
            submitLoader: document.getElementById('submit-loader'), submitButtonText: document.getElementById('submit-button-text'), submitStatus: document.getElementById('submit-status'), 
            calculateScoresButton: document.getElementById('calculateScoresButton'), adminStatus: document.getElementById('admin-status')
        };
        const showPage = (pageId) => { Object.values(pages).forEach(page => page.classList.add('hidden')); pages[pageId].classList.remove('hidden'); };
        const logout = () => { currentUser = ''; userPicks = {}; allElements.adminPasswordInput.value = ''; allElements.userPasswordInput.value = ''; showPage('landing'); };
        const setAdminStatus = (message, isError = false) => {
            allElements.adminStatus.textContent = message;
            allElements.adminStatus.className = `mt-4 text-sm text-center ${isError ? 'text-red-600' : 'text-green-600'}`;
            allElements.adminStatus.classList.remove('hidden');
            setTimeout(() => allElements.adminStatus.classList.add('hidden'), 4000);
        };
        
        const initializeData = async () => {
            try {
                const [scheduleRes, playersRes] = await Promise.all([ fetch('/.netlify/functions/get-schedule'), fetch('/.netlify/functions/get-players') ]);
                if (!scheduleRes.ok) throw new Error(`Schedule fetch failed: ${await scheduleRes.text()}`);
                if (!playersRes.ok) throw new Error(`Players fetch failed: ${await playersRes.text()}`);
                scheduleData = await scheduleRes.json(); playerData = await playersRes.json();
                populateWeekSelectors(); showPage('landing');
            } catch (error) { document.body.innerHTML = `<div class="p-8 text-center text-red-600"><h1>Initialization Error</h1><p>Could not load league data. Please check the Netlify function logs and Airtable configuration.</p><p class="mt-2 text-sm font-mono">${error.message}</p></div>`; }
        };
        
        const populatePlayerNameSelector = () => {
            playerData.sort((a,b) => a.fields.Name.localeCompare(b.fields.Name));
            allElements.userNameSelect.innerHTML = '<option value="">-- Select your name --</option>';
            playerData.forEach(player => { const option = document.createElement('option'); option.value = player.fields.Name; option.textContent = player.fields.Name; allElements.userNameSelect.appendChild(option); });
        };
        const populateWeekSelectors = () => {
            const weeks = [...new Set(scheduleData.map(match => match.fields.Week))].sort((a, b) => a - b);
            [allElements.weekSelectorUser, allElements.weekSelectorAdmin, allElements.weekSelectorResults].forEach(selector => {
                selector.innerHTML = '';
                weeks.forEach(weekNum => { const option = document.createElement('option'); option.value = weekNum; option.textContent = `Week ${weekNum}`; selector.appendChild(option); });
            });
        };
        const renderUserForm = (weekNumber) => {
            const container = document.getElementById('weeks-container-user');
            const matchesForWeek = scheduleData.filter(m => m.fields.Week === parseInt(weekNumber));
            if (!userPicks[weekNumber]) userPicks[weekNumber] = {};
            container.innerHTML = '';
            const matchesGrid = document.createElement('div'); matchesGrid.className = 'grid grid-cols-1 gap-6';
            matchesForWeek.forEach((match) => {
                const matchId = match.id;
                const matchCard = document.createElement('div'); matchCard.className = 'match-card bg-white p-4 rounded-lg shadow-sm border border-gray-200';
                const header = document.createElement('div'); header.className = 'flex justify-between items-center mb-4';
                const teams = document.createElement('p'); teams.className = 'text-base sm:text-lg font-semibold text-gray-700'; teams.innerHTML = `${match.fields['Away Team']} <span class="text-gray-500 font-normal">at</span> ${match.fields['Home Team']}`;
                const valueBadge = document.createElement('div'); valueBadge.textContent = `${match.fields.Value} pt${match.fields.Value > 1 ? 's' : ''}`; valueBadge.className = `text-xs sm:text-sm font-bold py-1 px-2 rounded-full ${match.fields.Value > 1 ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-100 text-gray-800'}`;
                header.appendChild(teams); header.appendChild(valueBadge);
                const buttonContainer = document.createElement('div'); buttonContainer.className = 'grid grid-cols-2 gap-2 sm:gap-4';
                const awayButton = document.createElement('button'); awayButton.textContent = match.fields['Away Team']; awayButton.className = 'team-pick-button w-full p-3 rounded-lg font-semibold';
                const homeButton = document.createElement('button'); homeButton.textContent = match.fields['Home Team']; homeButton.className = 'team-pick-button w-full p-3 rounded-lg font-semibold';
                if (userPicks[weekNumber][matchId] === match.fields['Away Team']) awayButton.classList.add('selected');
                if (userPicks[weekNumber][matchId] === match.fields['Home Team']) homeButton.classList.add('selected');
                awayButton.addEventListener('click', () => { userPicks[weekNumber][matchId] = match.fields['Away Team']; awayButton.classList.add('selected'); homeButton.classList.remove('selected'); });
                homeButton.addEventListener('click', () => { userPicks[weekNumber][matchId] = match.fields['Home Team']; homeButton.classList.add('selected'); awayButton.classList.remove('selected'); });
                buttonContainer.appendChild(awayButton); buttonContainer.appendChild(homeButton);
                matchCard.appendChild(header); matchCard.appendChild(buttonContainer);
                matchesGrid.appendChild(matchCard);
            });
            container.appendChild(matchesGrid);
        };
        const renderAdminForm = (weekNumber) => {
            const container = document.getElementById('weeks-container-admin');
            const matchesForWeek = scheduleData.filter(m => m.fields.Week === parseInt(weekNumber));
            container.innerHTML = '';
            const adminGrid = document.createElement('div'); adminGrid.className = 'space-y-4';
            matchesForWeek.forEach((match) => {
                const matchRow = document.createElement('div'); matchRow.className = 'flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded-lg shadow-sm';
                matchRow.dataset.id = match.id;
                const teams = document.createElement('p'); teams.className = 'text-gray-700 font-medium text-center sm:text-left mb-2 sm:mb-0 flex-1'; teams.textContent = `${match.fields['Away Team']} at ${match.fields['Home Team']}`;
                const inputWrapper = document.createElement('div'); inputWrapper.className = 'flex items-center gap-2';
                const label = document.createElement('label'); label.textContent = 'Points:'; label.className = 'text-sm font-medium';
                const input = document.createElement('input'); input.type = 'number'; input.min = '0'; input.value = match.fields.Value; input.className = 'match-value-input w-20 p-2 border border-gray-300 rounded-lg text-center';
                inputWrapper.appendChild(label); inputWrapper.appendChild(input);
                matchRow.appendChild(teams); matchRow.appendChild(inputWrapper);
                adminGrid.appendChild(matchRow);
            });
            container.appendChild(adminGrid);
        };
        const renderAdminPlayerManagement = () => {
            const container = document.getElementById('player-management-container'); container.innerHTML = '';
            playerData.forEach((player) => {
                const playerRow = document.createElement('div'); playerRow.className = 'player-row flex flex-col sm:flex-row items-center gap-2 bg-white p-3 rounded-lg';
                playerRow.dataset.id = player.id;
                playerRow.innerHTML = `<input type="text" value="${player.fields.Name}" class="player-name-input flex-1 w-full sm:w-auto p-2 border rounded" placeholder="Player Name"><input type="text" value="${player.fields.Password}" class="player-password-input flex-1 w-full sm:w-auto p-2 border rounded" placeholder="Password"><button class="remove-player-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 w-full sm:w-auto">Remove</button>`;
                container.appendChild(playerRow);
            });
            document.querySelectorAll('.remove-player-btn').forEach(btn => { btn.addEventListener('click', (e) => {
                e.target.closest('.player-row').dataset.deleted = "true";
                e.target.closest('.player-row').classList.add('hidden');
            }); });
        };
        const renderAdminResults = (weekNumber) => {
            const container = document.getElementById('weeks-container-results');
            const matchesForWeek = scheduleData.filter(m => m.fields.Week === parseInt(weekNumber));
            container.innerHTML = '';
            const adminGrid = document.createElement('div'); adminGrid.className = 'space-y-4';
            matchesForWeek.forEach((match) => {
                const matchRow = document.createElement('div'); matchRow.className = 'flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded-lg shadow-sm';
                matchRow.dataset.matchIdentifier = `${match.fields['Away Team']}-${match.fields['Home Team']}`;
                matchRow.dataset.id = match.id;
                const teams = document.createElement('p'); teams.className = 'text-gray-700 font-medium text-center sm:text-left mb-2 sm:mb-0 flex-1'; teams.textContent = `${match.fields['Away Team']} at ${match.fields['Home Team']}`;
                const selectWrapper = document.createElement('div');
                const winnerSelect = document.createElement('select'); winnerSelect.className = 'winner-select w-48 p-2 border border-gray-300 rounded-lg';
                winnerSelect.innerHTML = `<option value="">-- Select Winner --</option><option value="${match.fields['Away Team']}">${match.fields['Away Team']}</option><option value="${match.fields['Home Team']}">${match.fields['Home Team']}</option>`;
                winnerSelect.value = match.fields['Winning Team'] || "";
                selectWrapper.appendChild(winnerSelect);
                matchRow.appendChild(teams); matchRow.appendChild(selectWrapper);
                adminGrid.appendChild(matchRow);
            });
            container.appendChild(adminGrid);
        };
        const renderResultsPage = async () => {
            const container = document.getElementById('leaderboard-container');
            const winnerContainer = document.getElementById('leaderboard-winner');
            container.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const res = await fetch('/.netlify/functions/get-leaderboard');
                if(!res.ok) throw new Error('Failed to fetch leaderboard data.');
                const scores = await res.json();
                
                const weeklyScores = {};
                const totalScores = {};
                const weeks = [...new Set(scheduleData.map(s => s.fields.Week))].sort((a,b) => a - b);
                playerData.forEach(p => {
                    weeklyScores[p.fields.Name] = {};
                    totalScores[p.fields.Name] = 0;
                });

                scores.forEach(score => {
                    if (score.Player) {
                        weeklyScores[score.Player][score.Week] = score.Score;
                        totalScores[score.Player] += score.Score;
                    }
                });

                const sortedPlayers = Object.keys(totalScores).sort((a, b) => totalScores[b] - totalScores[a]);
                if (sortedPlayers.length > 0 && totalScores[sortedPlayers[0]] > 0) {
                    winnerContainer.innerHTML = `Current Leader: <span class="font-bold text-indigo-600">${sortedPlayers[0]}</span> with ${totalScores[sortedPlayers[0]]} points.`;
                } else {
                    winnerContainer.innerHTML = 'No scores have been calculated yet.';
                }
                
                let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>`;
                weeks.forEach(w => tableHTML += `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Wk ${w}</th>`);
                tableHTML += `<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th></tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
                
                playerData.sort((a,b) => totalScores[b.fields.Name] - totalScores[a.fields.Name]).forEach(playerObj => {
                    const player = playerObj.fields.Name;
                    tableHTML += `<tr><td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${player}</td>`;
                    weeks.forEach(w => {
                        tableHTML += `<td class="px-2 py-4 whitespace-nowrap text-center text-gray-500">${weeklyScores[player] ? (weeklyScores[player][w] || 0) : 0}</td>`;
                    });
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-center font-bold text-gray-900">${totalScores[player]}</td></tr>`;
                });

                tableHTML += `</tbody></table>`;
                container.innerHTML = tableHTML;
            } catch(e) { container.innerHTML = `<p class="text-red-500">Error loading leaderboard.</p>`; }
        };
        
        allElements.showUserLoginBtn.addEventListener('click', () => { populatePlayerNameSelector(); showPage('userLogin'); });
        allElements.showAdminLoginBtn.addEventListener('click', () => showPage('adminLogin'));
        allElements.showResultsBtn.addEventListener('click', () => { renderResultsPage(); showPage('results'); });
        allElements.backBtns.forEach(btn => btn.addEventListener('click', () => showPage('landing')));
        allElements.logoutUserBtn.addEventListener('click', logout);
        allElements.logoutAdminBtn.addEventListener('click', logout);

        allElements.userLoginBtn.addEventListener('click', () => {
            const selectedName = allElements.userNameSelect.value;
            const enteredPassword = allElements.userPasswordInput.value;
            const player = playerData.find(p => p.fields.Name === selectedName);
            if (player && player.fields.Password === enteredPassword) {
                currentUser = selectedName; allElements.userError.classList.add('hidden');
                document.getElementById('user-greeting').textContent = `Welcome, ${currentUser}! Make your picks below.`;
                showPage('userForm'); renderUserForm(allElements.weekSelectorUser.value);
            } else { allElements.userError.classList.remove('hidden'); }
        });
        allElements.adminLoginBtn.addEventListener('click', () => {
            if (allElements.adminPasswordInput.value === '1234') {
                allElements.adminError.classList.add('hidden'); showPage('adminForm');
                renderAdminForm(allElements.weekSelectorAdmin.value); 
                renderAdminResults(allElements.weekSelectorResults.value);
                renderAdminPlayerManagement();
            } else { allElements.adminError.classList.remove('hidden'); }
        });

        allElements.weekSelectorUser.addEventListener('change', (e) => { allElements.submitStatus.classList.add('hidden'); renderUserForm(e.target.value); });
        allElements.weekSelectorAdmin.addEventListener('change', (e) => renderAdminForm(e.target.value));
        allElements.weekSelectorResults.addEventListener('change', (e) => renderAdminResults(e.target.value));
        
        allElements.addPlayerBtn.addEventListener('click', () => {
            const container = document.getElementById('player-management-container');
            const playerRow = document.createElement('div'); playerRow.className = 'player-row flex flex-col sm:flex-row items-center gap-2 bg-white p-3 rounded-lg';
            playerRow.dataset.id = "new-" + Date.now();
            playerRow.innerHTML = `<input type="text" value="" class="player-name-input flex-1 w-full sm:w-auto p-2 border rounded" placeholder="New Player Name"><input type="text" value="12345" class="player-password-input flex-1 w-full sm:w-auto p-2 border rounded" placeholder="Password"><button class="remove-player-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 w-full sm:w-auto">Remove</button>`;
            container.appendChild(playerRow);
            playerRow.querySelector('.remove-player-btn').addEventListener('click', (e) => e.target.closest('.player-row').remove());
        });

        allElements.savePlayerChangesBtn.addEventListener('click', async (e) => {
            e.target.disabled = true;
            const updates = { created: [], updated: [], deleted: [] };
            document.querySelectorAll('.player-row').forEach(row => {
                const id = row.dataset.id;
                const name = row.querySelector('.player-name-input').value.trim();
                const password = row.querySelector('.player-password-input').value.trim();
                if(row.dataset.deleted === "true") {
                    if(!id.startsWith("new-")) updates.deleted.push(id);
                } else if (id.startsWith("new-")) {
                    updates.created.push({ fields: { Name: name, Password: password } });
                } else {
                    updates.updated.push({ id, fields: { Name: name, Password: password } });
                }
            });
            try {
                const res = await fetch('/.netlify/functions/update-players', { method: 'POST', body: JSON.stringify(updates) });
                if (!res.ok) throw new Error('Server error saving players.');
                playerData = await res.json();
                renderAdminPlayerManagement();
                setAdminStatus("Player list saved!");
            } catch (error) { setAdminStatus(`Error: ${error.message}`, true); }
            finally { e.target.disabled = false; }
        });

        allElements.saveAdminChangesBtn.addEventListener('click', async (e) => {
            e.target.disabled = true;
            const recordsToUpdate = [];
            document.querySelectorAll('#weeks-container-admin [data-id]').forEach(row => {
                recordsToUpdate.push({
                    id: row.dataset.id,
                    fields: { Value: parseInt(row.querySelector('.match-value-input').value, 10) || 0 }
                });
            });
            try {
                const res = await fetch('/.netlify/functions/update-schedule', { method: 'POST', body: JSON.stringify(recordsToUpdate) });
                if (!res.ok) throw new Error('Server error saving schedule.');
                scheduleData = await res.json();
                setAdminStatus("Point values saved!");
            } catch (error) { setAdminStatus(`Error: ${error.message}`, true); }
            finally { e.target.disabled = false; }
        });

        allElements.calculateScoresButton.addEventListener('click', async (e) => {
            e.target.disabled = true;
            const week = allElements.weekSelectorResults.value;
            const winners = {};
            let allWinnersSelected = true;
            document.querySelectorAll('#weeks-container-results [data-match-identifier]').forEach(row => {
                const winner = row.querySelector('.winner-select').value;
                if(!winner) allWinnersSelected = false;
                winners[row.dataset.matchIdentifier] = winner;
            });

            if (!allWinnersSelected) {
                alert('Please select a winner for every match before calculating scores.');
                e.target.disabled = false;
                return;
            }

            try {
                // First, save the winners to the schedule
                const scheduleUpdates = [];
                document.querySelectorAll('#weeks-container-results [data-id]').forEach(row => {
                    scheduleUpdates.push({ id: row.dataset.id, fields: { 'Winning Team': row.querySelector('.winner-select').value } });
                });
                const scheduleRes = await fetch('/.netlify/functions/update-schedule', { method: 'POST', body: JSON.stringify(scheduleUpdates) });
                if (!scheduleRes.ok) throw new Error('Could not save winners.');
                scheduleData = await scheduleRes.json();

                // Then, trigger score calculation
                const calcRes = await fetch('/.netlify/functions/calculate-scores', { method: 'POST', body: JSON.stringify({ week, winners }) });
                if (!calcRes.ok) throw new Error('Could not calculate scores.');
                const calcData = await calcRes.json();
                setAdminStatus(calcData.message);
            } catch (error) { setAdminStatus(`Error: ${error.message}`, true); }
            finally { e.target.disabled = false; }
        });
        
        allElements.submitPicksButton.addEventListener('click', () => {
            const weekNumber = allElements.weekSelectorUser.value;
            const matchesForWeek = scheduleData.filter(m => m.fields.Week === parseInt(weekNumber));
            const picksForWeek = userPicks[weekNumber] || {};
            if (Object.keys(picksForWeek).length === 0) {
                alert('Please make at least one pick before submitting.'); return;
            }
            allElements.submitPicksButton.disabled = true; allElements.submitButtonText.textContent = 'Submitting...';
            allElements.submitLoader.classList.remove('hidden'); allElements.submitStatus.classList.add('hidden');
            
            const submissionData = {
                playerName: currentUser,
                picks: matchesForWeek
                    .filter(match => picksForWeek[match.id])
                    .map(match => ({
                        week: weekNumber, away: match.fields['Away Team'], home: match.fields['Home Team'], 
                        pick: picksForWeek[match.id], value: match.fields.Value
                    }))
            };
            
            fetch('/.netlify/functions/submit-pick', { method: 'POST', body: JSON.stringify(submissionData) })
            .then(res => res.json().then(data => ({ ok: res.ok, data })))
            .then(({ok, data}) => {
                if (!ok) throw new Error(data.message);
                allElements.submitStatus.textContent = data.message;
                allElements.submitStatus.className = 'text-lg mt-4 text-center text-green-600';
            })
            .catch(error => {
                allElements.submitStatus.textContent = `Error: ${error.message}`;
                allElements.submitStatus.className = 'text-lg mt-4 text-center text-red-600';
            })
            .finally(() => {
                allElements.submitPicksButton.disabled = false; allElements.submitButtonText.textContent = 'Submit Picks';
                allElements.submitLoader.classList.add('hidden'); allElements.submitStatus.classList.remove('hidden');
            });
        });
        
        initializeData();
    });
    </script>
</body>
</html>